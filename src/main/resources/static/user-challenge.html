<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Jun Yin Captcha Tool</title>

    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>

        h2 {
            background: linear-gradient(to right, #76dc5a, #80ead6);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        #validationMessage {
            display: none;
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            z-index: 1000;
            font-size: 1.2em;
        }

        .success {
            color: #4F8A10;
            background-color: #DFF2BF;
        }

        .failure {
            color: #D8000C;
            background-color: #FFBABA;
        }

        .expired {
            color: #9E9E06;
            background-color: #FFF5BA;
        }

        #captchaQuestion strong {
            font-weight: bold;
            font-size: 1.2em; /* Example size, adjust as needed */
            /* Add more styles as needed */
        }

        #messageBox {
            display: none; /* Hidden by default */
            position: fixed; /* Or absolute, depending on your layout */
            top: 20%; /* Adjust as necessary */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            background-color: #f8f8f8; /* Light grey background */
            border: 1px solid #ccc; /* Slight border */
            border-radius: 5px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle shadow */
            z-index: 1000; /* Make sure it's above other content */
            text-align: center;
            color: #333; /* Dark grey text */
            max-width: 80%; /* Don't let the box get too wide */
            box-sizing: border-box;
        }

        .radio-container {
            margin-bottom: 10px; /* spacing between each radio button */
        }

        /* Style for custom radio buttons */
        .custom-radio {
            margin-right: 5px; /* spacing between the radio button and the label */
        }

        /* Style for labels */
        .custom-label {
            display: inline-block;
            padding: 5px 10px; /* spacing inside the label */
            background-color: #f8f8f8; /* a light grey background */
            border-radius: 4px; /* rounded corners */
            cursor: pointer;
        }

        /* Optional: hide the default radio button and style the label instead */
        .custom-radio {
            display: none;
        }

        .custom-label:before {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border: 2px solid #999; /* border color for unchecked state */
            border-radius: 50%;
            vertical-align: middle;
        }

        /* When the radio button is checked, change the border color */
        .custom-radio:checked + .custom-label:before {
            border-color: #007bff; /* border color for checked state */
        }

    </style>
</head>

<body>
    <div class="container mt-5">
        <h2>User Captcha Challenge</h2>
        <form id="loginForm">
            <!--
            <div class="form-group mb-3" >
                <label for="loginId" style="margin-top:10px;" >Login ID</label>
                <input type="text" id="loginId" class="form-control" placeholder="Enter login ID" style="margin-top:10px;">
            </div>
            <div class="form-group mb-3">
                <label for="password" style="margin-top:10px;" >Password</label>
                <input type="password" id="password" class="form-control" placeholder="Password" style="margin-top:10px;">
            </div>
            -->

            <div class="mb-3">
                <label for="challengeType" class="form-label">Challenge Type:</label>
                <select id="challengeType" class="form-select">
                    <option value="-1" selected disabled hidden >Select Challenge Type</option>
                    <option value="0" >Single Tile</option>
                    <option value="1" >Multi Tiles</option>
                    <option value="2" >Image Typing</option>
                    <option value="3" >Image Labelling</option>
                </select>
            </div>

            <div class="form-group d-flex justify-content-center mb-3">
                <button type="button" id="requestCaptcha" class="btn btn-primary mr-2" style="margin-right:20px;">Request Captcha</button>
                <button type="button" id="requestRandomCaptcha" class="btn btn-warning">Request Random Captcha</button>
            </div>
        </form>

        <form id="validateForm">
            <div class="form-group mb-3" >
                <div id="captchaContainer" style="display: none;"></div>
            </div>

            <div id="captchaAnswerContainer" class="form-group mb-3">
                <label id="answerLabel" for="captchaAnswer">Answer :</label>
                <input type="text" id="captchaAnswer" class="form-control" placeholder="Enter captcha answer" style="margin-top:10px;">
                <input type="hidden" id="selectedImageIds" class="form-control">
                <div><radio></radio></div>
            </div>

            <button id="validateCaptcha" class="btn btn-success" style="margin-top:20px;" type="button" >Submit</button>
        </form>

        <div id="messageBox" style="display: none;"></div>
        <div id="validationMessage"></div>
    </div>

    <script>

        $(document).ready(function () {

            $('#requestCaptcha').click(function () {

                var challengeType = document.getElementById('challengeType').value;
                var url = '/pip/challenge/request/specific'; // Your API endpoint
                if (challengeType) {
                    url += '?challengeTypeInt=' + encodeURIComponent(challengeType);
                }
                fetch(url, {
                    method: 'GET'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Request Failed');
                    }
                    return response.json(); // This converts the response body to JSON
                }).then(data => {
                    // Clear existing images if any
                     $('#captchaContainer').empty();
                    // Handle single or multi tiles
                    if (data.challengeType === 0 || data.challengeType === 1) {

                        $('#answerChoiceContainer').hide();
                        data.captchaImages.imageSlicesBase64String.forEach((base64Image, index) => {
                            // Create new img element for each slice
                            const imageElement = $('<img width="150" style="border-radius: 15px; border: 2px solid black; margin: 5px;">').attr({
                                class: 'captcha-image', 'data-image-id': data.captchaImages.temporaryIds[index],
                                src: 'data:image/png;base64,' + base64Image,
                                alt: 'Captcha Slice ' + (index + 1)
                            });
                            // Append new img element to the captcha container
                            $('#captchaContainer').append(imageElement);
                        });

                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        // Append new p element to the captcha container
                        $('#captchaContainer').append(pElement);
                        $('#answerLabel').hide();
                        $('#captchaAnswer').hide();
                    }

                    if (data.challengeType === 2) {

                        $('#answerChoiceContainer').hide();
                        console.log("captcha images" + JSON.stringify(data.captchaImages));
                        console.log("captcha images based 64" + JSON.stringify(data.captchaImages.base64String));

                        // Create new img element for each slice
                        const imageElement = $('<img width="400" >').attr({
                            src: 'data:image/png;base64,' + data.captchaImages.base64String,
                            alt: 'Captcha Slice '
                        });
                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        $('#captchaContainer').append(imageElement);
                        $('#captchaContainer').append(pElement);
                        $('#answerLabel').show();
                        $('#captchaAnswer').show();
                    }

                    if (data.challengeType === 3) {

                        // $('#captchaAnswerContainer').remove("#answerChoiceContainer");
                        $('#answerChoiceContainer').remove();
                        // $('#answerChoiceContainer').empty();

                        console.log("captcha images" + JSON.stringify(data.captchaImages));
                        console.log("captcha images based 64" + JSON.stringify(data.captchaImages.base64String));

                        // Create new img element for each slice
                        const imageElement = $('<img width="400" >').attr({
                            src: 'data:image/png;base64,' + data.captchaImages.base64String,
                            alt: 'Captcha Slice '
                        });
                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        $('#captchaContainer').append(imageElement);
                        $('#captchaContainer').append(pElement);

                        const divElement = $('<div id="answerChoiceContainer"></div>');

                        // Iterate over each answer choice and create a radio button for each
                        data.answerChoice.forEach(function(choice, index) {
                            // Create the radio button element
                            var radioButton = $('<input>', {
                                type: 'radio',
                                id: 'choice-' + index,
                                name: 'captchaChoice',
                                value: choice,
                                class: 'custom-radio' // Add a class for styling
                            });

                            // Create the label element for the radio button
                            var label = $('<label>', {
                                for: 'choice-' + index,
                                text: choice,
                                class: 'custom-label' // Add a class for styling
                            });

                            // Append the radio button and label to the container
                            divElement.append(radioButton).append(label);
                        });

                        $('#captchaAnswerContainer').append(divElement);
                        $('#captchaAnswer').hide();
                    }

                    const typeElement = $('<input id="captchaType" style="display:none;">').val(data.challengeType);
                    const sessionIdElement = $('<input id="sessionId" style="display:none;">').val(data.sessionId);
                    $('#captchaContainer').append(typeElement);
                    $('#captchaContainer').append(sessionIdElement);
                    $('#captchaContainer').show();

                }).catch(error => {
                    console.error('Request captcha operation error : ', error);
                });
            });

            $('#requestRandomCaptcha').click(function () {

                // Disable the button
                $(this).prop('disabled', true);

                fetch('/pip/challenge/request', {
                    method: 'GET'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Request Failed');
                    }
                    return response.json(); // This converts the response body to JSON
                }).then(data => {

                    // Clear existing images if any
                    $('#captchaContainer').empty();
                    // Clear existing images if any
                    $('#answerChoiceContainer').empty();
                    $('#captchaAnswerContainer').remove($('#answerChoiceContainer'));

                    // Handle single or multi tiles
                    if (data.challengeType === 0 || data.challengeType === 1) {
                        data.captchaImages.imageSlicesBase64String.forEach((base64Image, index) => {
                            // Create new img element for each slice
                            const imageElement = $('<img width="150" style="border-radius: 15px; border: 2px solid black; margin: 5px;">>').attr({
                                class: 'captcha-image', 'data-image-id': data.captchaImages.temporaryIds[index],
                                src: 'data:image/png;base64,' + base64Image,
                                alt: 'Captcha Slice ' + (index + 1)
                            });
                            // Append new img element to the captcha container
                            $('#captchaContainer').append(imageElement);
                            $('#answerLabel').hide();
                            $('#captchaAnswer').hide();
                        });

                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        $('#captchaContainer').append(pElement);
                    }

                    if (data.challengeType === 2 ) {

                        $('#answerChoiceContainer').hide();
                        console.log("captcha images" + JSON.stringify(data.captchaImages));
                        console.log("captcha images based 64" + JSON.stringify(data.captchaImages.base64String));

                        // Create new img element for each slice
                        const imageElement = $('<img width="400" >').attr({
                            src: 'data:image/png;base64,' + data.captchaImages.base64String,
                            alt: 'Captcha Slice '
                        });
                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        $('#captchaContainer').append(imageElement);
                        $('#captchaContainer').append(pElement);
                        $('#answerLabel').show();
                        $('#captchaAnswer').show();

                    }

                    if (data.challengeType === 3 ) {

                        // $('#captchaAnswerContainer').remove("#answerChoiceContainer");
                        $('#answerChoiceContainer').remove();
                        // $('#answerChoiceContainer').empty();

                        console.log("captcha images" + JSON.stringify(data.captchaImages));
                        console.log("captcha images based 64" + JSON.stringify(data.captchaImages.base64String));

                        // Create new img element for each slice
                        const imageElement = $('<img width="400" >').attr({
                            src: 'data:image/png;base64,' + data.captchaImages.base64String,
                            alt: 'Captcha Slice '
                        });
                        const pElement = $('<p id="captchaQuestion" style="margin-top:10px; margin:-bottom:10px;">').html('<strong>' + data.questionString + '</strong>');
                        $('#captchaContainer').append(imageElement);
                        $('#captchaContainer').append(pElement);

                        const divElement = $('<div id="answerChoiceContainer"></div>');

                        // Iterate over each answer choice and create a radio button for each
                        data.answerChoice.forEach(function(choice, index) {
                            // Create the radio button element
                            var radioButton = $('<input>', {
                                type: 'radio',
                                id: 'choice-' + index,
                                name: 'captchaChoice',
                                value: choice,
                                class: 'custom-radio' // Add a class for styling
                            });

                            // Create the label element for the radio button
                            var label = $('<label>', {
                                for: 'choice-' + index,
                                text: choice,
                                class: 'custom-label' // Add a class for styling
                            });

                            // Append the radio button and label to the container
                            divElement.append(radioButton).append(label);
                        });

                        $('#captchaAnswerContainer').append(divElement);
                        $('#captchaAnswer').hide();
                    }

                    const typeElement = $('<input id="captchaType" style="display:none;">').val(data.challengeType);
                    const sessionIdElement = $('<input id="sessionId" style="display:none;">').val(data.sessionId);

                    $('#captchaContainer').append(typeElement);
                    $('#captchaContainer').append(sessionIdElement);
                    $('#captchaContainer').show();

                }).catch(error => {
                    console.error('Request captcha operation error : ', error);
                });

                // Re-enable the button after 10 seconds
                setTimeout(() => {
                    $(this).prop('disabled', false);
                }, 10000); // 10 seconds
            });


            $('#validateCaptcha').click(function () {

                console.log('hii')

                // Create a FormData object to send form data
                const formData = new FormData();

                const captchaAnswer = document.getElementById('captchaAnswer').value;
                const captchaType = document.getElementById('captchaType').value;
                const sessionId = document.getElementById('sessionId').value;

                if (captchaType) {
                    formData.append('challengeTypeInt', captchaType);
                }
                if (sessionId) {
                    formData.append('sessionId', sessionId);
                }

                console.log("challenge type " + captchaType);
                console.log("captcha answer " + captchaAnswer);

                if ( captchaType === '0' || captchaType === '1') {
                    // Get selected image IDs
                    var selectedImageIds = $('#selectedImageIds').val();
                    formData.append('captchaAnswer', selectedImageIds);
                }

                if ( captchaType === '2') {
                    if (captchaAnswer) {
                        formData.append('captchaAnswer', captchaAnswer);
                    }
                }

                if ( captchaType === '3') {
                   var answerChoice = $('input[name="captchaChoice"]:checked').val();
                   console.log('selected answer choice:', answerChoice);
                   if(answerChoice){
                       formData.append('captchaAnswer', answerChoice);
                   }
                }

                console.log(JSON.stringify(formData,null,2));
                console.log("Validating challenge ... ");
                fetch('/pip/challenge/validate', {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    console.log('1')
                    console.log(response);
                    return response.text()
                }).then (data => {
                    console.log('2')
                    console.log(data);
                        var message;
                        var messageClass;
                        if( data === "SUCCESS"){
                            message = "You passed the captcha challenge";
                            messageClass = "success";
                        } else if ( data === "FAILED"){
                            message = "You failed the captcha challenge";
                            messageClass = "failure";
                        } else if ( data === "EXPIRED"){
                            message = "Captcha challenge expired, refresh the page to try again";
                            messageClass = "expired";
                        }
                        showMessage(message, messageClass);
                    });
            });

            // Event delegation for dynamically added elements
            $('#captchaContainer').on('click', '.captcha-image', function() {
                var isSelected = $(this).hasClass('selected');
                $(this).toggleClass('selected');
                if ($(this).hasClass('selected')) {
                    $(this).css('border', '5px solid black');
                } else {
                    $(this).css('border', '2px solid black');
                }
                updateSelectedImages();

                // Display a temporary message
                var message = isSelected ? "Deselected Image " : "Selected Image ";
                // Assuming you have a div with id 'messageBox' to show the notification
                $('#messageBox').text(message)
                    .fadeIn(200) // Fade in over half a second
                    .delay(300) // Stay visible for 2 seconds
                    .fadeOut(200); // Slide up to hide over half a second
            });
        });

        function updateSelectedImages() {
            var selectedIds = $('.captcha-image.selected').map(function () {
                return $(this).data('image-id');
            }).get().join(',');
            $('#selectedImageIds').val(selectedIds);
            console.log("selected images are : " + selectedIds);
        }

        function showMessage(message, messageClass) {
            let validationMessageDiv = $('#validationMessage');
            validationMessageDiv.removeClass('success failure expired');
            validationMessageDiv.addClass(messageClass).text(message).fadeIn(500).delay(3000).fadeOut(500, function() {
                // Remove the inline styles after fade out
                validationMessageDiv.removeAttr('style');
            });
        }

    </script>
</body>